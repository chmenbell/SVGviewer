server {
    listen 80;
    server_name ${DOMAIN} ${SERVER_IP};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    server_name ${DOMAIN} ${SERVER_IP};

    ssl_certificate /etc/nginx/ssl/${APP_NAME}.crt;
    ssl_certificate_key /etc/nginx/ssl/${APP_NAME}.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";

    client_max_body_size 100M;

    location / {
        root /opt/${APP_NAME}/frontend/dist;
        try_files \$uri \$uri/ /index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires 0;
    }

    location /api {
        proxy_pass http://localhost:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-CSRFToken \$http_x_csrf_token;
        proxy_cookie_path / "/; SameSite=Lax; Secure";
    }

    location /admin {
        proxy_pass http://localhost:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /login {
        proxy_pass http://localhost:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /logout {
        proxy_pass http://localhost:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /static/ {
        alias /opt/${APP_NAME}/static/;
        expires 30d;
        add_header Cache-Control "public";
    }

    location /static/admin {
        alias /usr/lib/python3/dist-packages/django/contrib/admin/static/admin;
        expires 30d;
        add_header Cache-Control "public";
    }

    location /media/ {
        alias /opt/${APP_NAME}/media/;
        expires 30d;
        add_header Cache-Control "public";
    }
}